<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- スマホ向け表示 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metronome</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #111827;
      color: #e5e7eb;
      padding: 16px;
    }
    .metronome {
      background: #1f2937;
      padding: 20px 18px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.5);
      width: min(420px, 100%);
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .lang-switch {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 10px;
    }
    .lang-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #9ca3af;
      font-size: 11px;
      cursor: pointer;
    }
    .lang-btn.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #f9fafb;
    }
    .control-group {
      margin-bottom: 16px;
    }
    .control-group label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .control-group input[type="number"] {
      width: 95px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .control-group input[type="range"] {
      width: 100%;
      touch-action: pan-y;
    }
    .control-group select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .flex-row.small > span {
      font-size: 11px;
      color: #9ca3af;
    }
    .flex-row.small input[type="number"] {
      width: 70px;
    }
    .ladder-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #e5e7eb;
      margin-top: 4px;
    }
    .ladder-toggle input {
      width: 16px;
      height: 16px;
    }
    button {
      width: 100%;
      padding: 12px 0;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      background: #10b981;
      color: #022c22;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.2s;
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
      -webkit-tap-highlight-color: transparent;
    }
    button:hover {
      background: #34d399;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);
    }
    button.stop {
      background: #ef4444;
      color: #fee2e2;
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }
    button.stop:hover {
      background: #f97373;
    }
    .indicator-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .beat-dot {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: #374151;
      opacity: 0.4;
      transition: background 0.12s, transform 0.12s, opacity 0.12s;
    }
    .beat-dot.active {
      opacity: 1;
      transform: scale(1.25);
    }
    .beat-dot.accent {
      border: 2px solid #fbbf24;
    }
    .beat-dot.accent.active {
      background: #fbbf24;
    }
    .small-text {
      margin-top: 10px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      line-height: 1.4;
    }
    @media (max-width: 360px) {
      .metronome {
        padding: 16px 14px;
        border-radius: 14px;
      }
      h1 {
        font-size: 18px;
      }
      .beat-dot {
        width: 14px;
        height: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="metronome">
    <h1 id="appTitle">メトロノーム</h1>
    <div id="subtitle" class="subtitle">
      高精度＋サブディビジョン＋ジャンル＋テンポ階段
    </div>

    <!-- 言語切り替え -->
    <div class="lang-switch">
      <button class="lang-btn" data-lang="ja">日本語</button>
      <button class="lang-btn" data-lang="en">English</button>
    </div>

    <!-- BPM -->
    <div class="control-group">
      <label>
        <span>BPM</span>
        <span><span id="bpmDisplay">120</span> bpm</span>
      </label>
      <input id="bpmSlider" type="range" min="40" max="240" step="1" value="120">
      <div class="flex-row" style="margin-top: 4px;">
        <span id="bpmInputHint" style="font-size: 11px; color:#9ca3af;">数値で調整</span>
        <input
          id="bpmInput"
          type="number"
          min="40"
          max="240"
          value="120"
          inputmode="numeric"
        >
      </div>
    </div>

    <!-- 拍子 -->
    <div class="control-group">
      <label for="beatsPerBar">
        <span id="beatsLabelTitleText">拍子（1小節の拍数）</span>
        <span id="beatsLabel">
          <span id="beatsLabelCount">4</span>
          <span id="beatsLabelUnit"> 拍</span>
        </span>
      </label>
      <input
        id="beatsPerBar"
        type="number"
        min="1"
        max="8"
        value="4"
        inputmode="numeric"
      >
    </div>

    <!-- 細かいリズム -->
    <div class="control-group">
      <label for="subdivision">
        <span id="subdivisionLabelText">細かいリズム</span>
        <span id="subLabel">なし</span>
      </label>
      <select id="subdivision">
        <option value="1">なし（1拍のみ）</option>
        <option value="2">8分音符（1拍を2つ）</option>
        <option value="3">3連符（1拍を3つ）</option>
        <option value="4">16分音符（1拍を4つ）</option>
      </select>
    </div>

    <!-- プリセット -->
    <div class="control-group">
      <label for="preset">
        <span id="presetLabelText">リズムプリセット</span>
        <span id="presetLabel">基本</span>
      </label>
      <select id="preset">
        <option value="basic">基本（素直なカチッ）</option>
        <option value="rock">ロック 8ビート</option>
        <option value="funk">ファンク 16ビート</option>
        <option value="pops">ポップス 16ビート</option>
      </select>
    </div>

    <!-- テンポ階段モード -->
    <div class="control-group">
      <label>
        <span id="ladderTitleText">テンポ階段モード</span>
        <span id="ladderStatus">OFF</span>
      </label>
      <div class="flex-row small">
        <span id="ladderStepLabelLeft">上げ幅</span>
        <input id="ladderStep" type="number" min="1" max="20" value="4" inputmode="numeric">
        <span id="ladderStepLabelRight">BPM</span>
      </div>
      <div class="flex-row small" style="margin-top:4px;">
        <span id="ladderIntervalLabelLeft">間隔</span>
        <input id="ladderInterval" type="number" min="5" max="300" value="30" inputmode="numeric">
        <span id="ladderIntervalLabelRight">秒ごと</span>
      </div>
      <div class="flex-row small" style="margin-top:4px;">
        <span id="ladderCountLabelLeft">回数</span>
        <input id="ladderCount" type="number" min="1" max="50" value="10" inputmode="numeric">
        <span id="ladderCountLabelRight">回</span>
      </div>
      <label class="ladder-toggle">
        <input type="checkbox" id="ladderEnabled">
        <span id="ladderToggleText">テンポ階段を有効にする（再生中のみ動作）</span>
      </label>
    </div>

    <!-- 再生ボタン -->
    <button id="toggleBtn">▶ 再生</button>

    <!-- 拍インジケータ -->
    <div id="indicatorRow" class="indicator-row"></div>
    <div id="smallText" class="small-text">
      ● 一番左がアクセント（1拍目）<br>
      ● プリセット＋細かいリズム＋テンポ階段で、ジャンル別のノリとテンポアップ練習ができます
    </div>
  </div>

  <script>
    // ====== i18n 定義 ======
    const i18n = {
      ja: {
        appTitle: "メトロノーム",
        subtitle: "高精度＋サブディビジョン＋ジャンル＋テンポ階段",
        bpmInputHint: "数値で調整",
        beatsLabelTitle: "拍子（1小節の拍数）",
        beatsUnit: " 拍",
        subdivisionLabel: "細かいリズム",
        subdivisionOptions: [
          "なし（1拍のみ）",
          "8分音符（1拍を2つ）",
          "3連符（1拍を3つ）",
          "16分音符（1拍を4つ）"
        ],
        subdivisionNone: "なし",
        subdivision8th: "8分音符（2分割）",
        subdivisionTriplet: "3連符（3分割）",
        subdivision16th: "16分音符（4分割）",
        presetLabel: "リズムプリセット",
        presetBasic: "基本（素直なカチッ）",
        presetRock: "ロック 8ビート",
        presetFunk: "ファンク 16ビート",
        presetPops: "ポップス 16ビート",
        ladderTitle: "テンポ階段モード",
        ladderStepLeft: "上げ幅",
        ladderStepRight: "BPM",
        ladderIntervalLeft: "間隔",
        ladderIntervalRight: "秒ごと",
        ladderCountLeft: "回数",
        ladderCountRight: "回",
        ladderToggleText: "テンポ階段を有効にする（再生中のみ動作）",
        playLabel: "▶ 再生",
        stopLabel: "■ 停止",
        smallText: "● 一番左がアクセント（1拍目）\n● プリセット＋細かいリズム＋テンポ階段で、ジャンル別のノリとテンポアップ練習ができます"
      },
      en: {
        appTitle: "Metronome",
        subtitle: "High-precision + subdivision + groove presets + tempo ladder",
        bpmInputHint: "Type BPM",
        beatsLabelTitle: "Time signature (beats per bar)",
        beatsUnit: " beats",
        subdivisionLabel: "Subdivision",
        subdivisionOptions: [
          "None (quarter notes only)",
          "8th notes (2 per beat)",
          "Triplets (3 per beat)",
          "16th notes (4 per beat)"
        ],
        subdivisionNone: "None",
        subdivision8th: "8th notes (2 per beat)",
        subdivisionTriplet: "Triplets (3 per beat)",
        subdivision16th: "16th notes (4 per beat)",
        presetLabel: "Rhythm preset",
        presetBasic: "Basic (straight click)",
        presetRock: "Rock 8-beat",
        presetFunk: "Funk 16-beat",
        presetPops: "Pops 16-beat",
        ladderTitle: "Tempo ladder",
        ladderStepLeft: "Step",
        ladderStepRight: "BPM",
        ladderIntervalLeft: "Interval",
        ladderIntervalRight: "seconds",
        ladderCountLeft: "Steps",
        ladderCountRight: "times",
        ladderToggleText: "Enable tempo ladder (works while playing)",
        playLabel: "▶ Start",
        stopLabel: "■ Stop",
        smallText: "● The leftmost dot is the accent (beat 1)\n● Use presets + subdivision + tempo ladder for groove and tempo-up practice"
      }
    };

    let currentLang = "ja";

    // ========= オーディオ部分 =========
    let audioCtx = null;

    function initAudioContext() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } else if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
    }

    function playClick(kind, time) {
      if (!audioCtx) return;
      const t = (typeof time === "number") ? time : audioCtx.currentTime;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      let freq = 1500;
      let level = 0.8;

      if (kind === "accent") {
        freq = 2100;
        level = 1.0;
      } else if (kind === "beat") {
        freq = 1600;
        level = 0.8;
      } else if (kind === "sub") {
        freq = 1100;
        level = 0.5;
      }

      osc.frequency.value = freq;

      gain.gain.setValueAtTime(level, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(t);
      osc.stop(t + 0.05);
    }

    // ========= DOM参照 =========
    const appTitleEl = document.getElementById("appTitle");
    const subtitleEl = document.getElementById("subtitle");
    const bpmSlider = document.getElementById("bpmSlider");
    const bpmInput = document.getElementById("bpmInput");
    const bpmDisplay = document.getElementById("bpmDisplay");
    const bpmInputHint = document.getElementById("bpmInputHint");
    const beatsPerBarInput = document.getElementById("beatsPerBar");
    const beatsLabelTitleText = document.getElementById("beatsLabelTitleText");
    const beatsLabelCount = document.getElementById("beatsLabelCount");
    const beatsLabelUnit = document.getElementById("beatsLabelUnit");
    const subdivisionSelect = document.getElementById("subdivision");
    const subdivisionLabelText = document.getElementById("subdivisionLabelText");
    const subLabel = document.getElementById("subLabel");
    const presetSelect = document.getElementById("preset");
    const presetLabelText = document.getElementById("presetLabelText");
    const presetLabel = document.getElementById("presetLabel");
    const ladderStepInput = document.getElementById("ladderStep");
    const ladderIntervalInput = document.getElementById("ladderInterval");
    const ladderCountInput = document.getElementById("ladderCount");
    const ladderEnabledCheckbox = document.getElementById("ladderEnabled");
    const ladderStatus = document.getElementById("ladderStatus");
    const ladderTitleText = document.getElementById("ladderTitleText");
    const ladderStepLabelLeft = document.getElementById("ladderStepLabelLeft");
    const ladderStepLabelRight = document.getElementById("ladderStepLabelRight");
    const ladderIntervalLabelLeft = document.getElementById("ladderIntervalLabelLeft");
    const ladderIntervalLabelRight = document.getElementById("ladderIntervalLabelRight");
    const ladderCountLabelLeft = document.getElementById("ladderCountLabelLeft");
    const ladderCountLabelRight = document.getElementById("ladderCountLabelRight");
    const ladderToggleText = document.getElementById("ladderToggleText");

    const toggleBtn = document.getElementById("toggleBtn");
    const indicatorRow = document.getElementById("indicatorRow");
    const smallTextEl = document.getElementById("smallText");
    const langButtons = document.querySelectorAll(".lang-btn");

    // ========= 状態 =========
    let isPlaying = false;
    let schedulerTimerID = null;
    let currentBeat = 0;
    let currentStep = 0;
    let nextNoteTime = 0.0;

    const lookahead = 25.0;
    const scheduleAheadTime = 0.1;

    // テンポ階段用
    let ladderTimerID = null;
    let ladderStepsRemaining = 0;

    // ========= ユーティリティ =========
    function clampBPM(value) {
      if (isNaN(value)) return 120;
      return Math.min(240, Math.max(40, value));
    }

    function clampBeats(value) {
      if (isNaN(value)) return 4;
      return Math.min(8, Math.max(1, value));
    }

    function clampInt(val, min, max, fallback) {
      if (isNaN(val)) return fallback;
      return Math.min(max, Math.max(min, val));
    }

    function getStepsPerBeat() {
      const v = parseInt(subdivisionSelect.value, 10);
      if (v === 2 || v === 3 || v === 4) return v;
      return 1;
    }

    function updateSubLabel() {
      const steps = getStepsPerBeat();
      const t = i18n[currentLang];
      let key = "subdivisionNone";
      if (steps === 2) key = "subdivision8th";
      else if (steps === 3) key = "subdivisionTriplet";
      else if (steps === 4) key = "subdivision16th";
      subLabel.textContent = t[key];
    }

    function updatePresetLabel() {
      const v = presetSelect.value;
      const t = i18n[currentLang];
      let text = t.presetBasic;
      if (v === "rock") text = t.presetRock;
      else if (v === "funk") text = t.presetFunk;
      else if (v === "pops") text = t.presetPops;
      presetLabel.textContent = text;
    }

    function setLadderStatus(active) {
      ladderStatus.textContent = active ? "ON" : "OFF";
      ladderStatus.style.color = active ? "#34d399" : "#9ca3af";
    }

    function updateIndicatorDots() {
      const beatsPerBar = clampBeats(parseInt(beatsPerBarInput.value || "4", 10));
      indicatorRow.innerHTML = "";
      for (let i = 0; i < beatsPerBar; i++) {
        const dot = document.createElement("div");
        dot.classList.add("beat-dot");
        if (i === 0) dot.classList.add("accent");
        if (i === currentBeat) dot.classList.add("active");
        indicatorRow.appendChild(dot);
      }
    }

    function setActiveBeat() {
      const dots = indicatorRow.querySelectorAll(".beat-dot");
      dots.forEach((d, idx) => {
        d.classList.toggle("active", idx === currentBeat);
      });
    }

    // ========= プリセットのクリック種別決定 =========
    function getClickKindForPreset(preset, beatIndex, stepInBeat, stepsPerBeat) {
      const isBeatHead = (stepInBeat === 0);

      function baseKind() {
        if (isBeatHead) {
          return (beatIndex === 0) ? "accent" : "beat";
        } else {
          return (stepsPerBeat > 1) ? "sub" : null;
        }
      }

      if (preset === "basic") return baseKind();

      if (preset === "rock") {
        if (stepsPerBeat < 2) return baseKind();

        if (isBeatHead) {
          if (beatIndex === 0 || beatIndex === 2) {
            return "accent";
          } else {
            return "beat";
          }
        } else {
          if (stepsPerBeat === 2 && stepInBeat === 1) return "sub";
          if (stepsPerBeat === 4 && stepInBeat === 2) return "sub";
          return null;
        }
      }

      if (preset === "funk") {
        if (isBeatHead) {
          return (beatIndex === 0) ? "accent" : "beat";
        } else {
          if (stepsPerBeat === 4) {
            if (stepInBeat === 2) return "beat";
            return "sub";
          }
          return "sub";
        }
      }

      if (preset === "pops") {
        if (isBeatHead) {
          return (beatIndex === 0) ? "accent" : "beat";
        } else {
          return (stepsPerBeat > 1) ? "sub" : null;
        }
      }

      return baseKind();
    }

    // ========= 時間進行（サブディビジョン単位） =========
    function advanceStep() {
      const bpm = clampBPM(parseInt(bpmInput.value || "120", 10));
      const beatsPerBar = clampBeats(parseInt(beatsPerBarInput.value || "4", 10));
      const stepsPerBeat = getStepsPerBeat();

      const secondsPerBeat = 60.0 / bpm;
      const secondsPerStep = secondsPerBeat / stepsPerBeat;

      nextNoteTime += secondsPerStep;

      const stepsPerBar = beatsPerBar * stepsPerBeat;
      currentStep = (currentStep + 1) % stepsPerBar;
    }

    // ========= メインスケジューラ =========
    function scheduler() {
      if (!isPlaying || !audioCtx) return;

      const beatsPerBar = clampBeats(parseInt(beatsPerBarInput.value || "4", 10));
      const stepsPerBeat = getStepsPerBeat();
      const preset = presetSelect.value;

      while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
        const stepsPerBar = beatsPerBar * stepsPerBeat;
        const beatIndex = Math.floor(currentStep / stepsPerBeat);
        const stepInBeat = currentStep % stepsPerBeat;

        const kind = getClickKindForPreset(preset, beatIndex, stepInBeat, stepsPerBeat);

        if (kind) {
          currentBeat = beatIndex;
          setActiveBeat();
          playClick(kind, nextNoteTime);
        }

        advanceStep();
      }

      schedulerTimerID = setTimeout(scheduler, lookahead);
    }

    // ========= テンポ階段モード =========
    function stopLadderTimer() {
      if (ladderTimerID !== null) {
        clearInterval(ladderTimerID);
        ladderTimerID = null;
      }
      ladderStepsRemaining = 0;
      setLadderStatus(false);
    }

    function startLadderIfNeeded() {
      stopLadderTimer();
      if (!ladderEnabledCheckbox.checked) {
        setLadderStatus(false);
        return;
      }

      const stepAmount = clampInt(
        parseInt(ladderStepInput.value, 10),
        1, 20, 4
      );
      const intervalSec = clampInt(
        parseInt(ladderIntervalInput.value, 10),
        3, 600, 30
      );
      const stepCount = clampInt(
        parseInt(ladderCountInput.value, 10),
        1, 100, 10
      );

      ladderStepInput.value = stepAmount;
      ladderIntervalInput.value = intervalSec;
      ladderCountInput.value = stepCount;

      if (stepCount <= 0 || stepAmount <= 0) {
        ladderEnabledCheckbox.checked = false;
        setLadderStatus(false);
        return;
      }

      ladderStepsRemaining = stepCount;
      const intervalMs = intervalSec * 1000;

      setLadderStatus(true);

      ladderTimerID = setInterval(() => {
        if (!isPlaying) {
          stopLadderTimer();
          return;
        }
        if (ladderStepsRemaining <= 0) {
          stopLadderTimer();
          ladderEnabledCheckbox.checked = false;
          return;
        }

        let currentBpm = clampBPM(parseInt(bpmInput.value || "120", 10));
        let newBpm = clampBPM(currentBpm + stepAmount);

        bpmInput.value = newBpm;
        bpmSlider.value = newBpm;
        bpmDisplay.textContent = newBpm;

        restartIfPlaying();

        ladderStepsRemaining -= 1;
        if (ladderStepsRemaining <= 0) {
          stopLadderTimer();
          ladderEnabledCheckbox.checked = false;
        }
      }, intervalMs);
    }

    // ========= 再生・停止 =========
    function startMetronome() {
      if (isPlaying) return;
      initAudioContext();
      if (!audioCtx) return;

      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();

      nextNoteTime = audioCtx.currentTime + 0.05;

      isPlaying = true;
      toggleBtn.textContent = i18n[currentLang].stopLabel;
      toggleBtn.classList.add("stop");

      scheduler();
      startLadderIfNeeded();
    }

    function stopMetronome() {
      if (!isPlaying) return;
      isPlaying = false;

      if (schedulerTimerID !== null) {
        clearTimeout(schedulerTimerID);
        schedulerTimerID = null;
      }

      stopLadderTimer();

      toggleBtn.textContent = i18n[currentLang].playLabel;
      toggleBtn.classList.remove("stop");

      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();
    }

    function restartIfPlaying() {
      if (!isPlaying || !audioCtx) return;

      if (schedulerTimerID !== null) {
        clearTimeout(schedulerTimerID);
        schedulerTimerID = null;
      }

      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();
      nextNoteTime = audioCtx.currentTime + 0.05;

      scheduler();
    }

    // ========= i18n 適用 =========
    function applyTranslations() {
      const t = i18n[currentLang];

      appTitleEl.textContent = t.appTitle;
      subtitleEl.textContent = t.subtitle;
      bpmInputHint.textContent = t.bpmInputHint;
      beatsLabelTitleText.textContent = t.beatsLabelTitle;
      beatsLabelUnit.textContent = t.beatsUnit;
      subdivisionLabelText.textContent = t.subdivisionLabel;
      presetLabelText.textContent = t.presetLabel;
      ladderTitleText.textContent = t.ladderTitle;
      ladderStepLabelLeft.textContent = t.ladderStepLeft;
      ladderStepLabelRight.textContent = t.ladderStepRight;
      ladderIntervalLabelLeft.textContent = t.ladderIntervalLeft;
      ladderIntervalLabelRight.textContent = t.ladderIntervalRight;
      ladderCountLabelLeft.textContent = t.ladderCountLeft;
      ladderCountLabelRight.textContent = t.ladderCountRight;
      ladderToggleText.textContent = t.ladderToggleText;

      // サブディビジョンのセレクト
      const subOpts = subdivisionSelect.options;
      const so = t.subdivisionOptions;
      for (let i = 0; i < subOpts.length && i < so.length; i++) {
        subOpts[i].textContent = so[i];
      }

      // プリセットセレクト
      const optBasic = presetSelect.querySelector('option[value="basic"]');
      const optRock = presetSelect.querySelector('option[value="rock"]');
      const optFunk = presetSelect.querySelector('option[value="funk"]');
      const optPops = presetSelect.querySelector('option[value="pops"]');
      if (optBasic) optBasic.textContent = t.presetBasic;
      if (optRock) optRock.textContent = t.presetRock;
      if (optFunk) optFunk.textContent = t.presetFunk;
      if (optPops) optPops.textContent = t.presetPops;

      // 拍数ラベルの値＋単位
      const beats = clampBeats(parseInt(beatsPerBarInput.value || "4", 10));
      beatsLabelCount.textContent = beats;

      // サブラベル・プリセットラベルを現在値から再計算
      updateSubLabel();
      updatePresetLabel();

      // 小さい説明文
      smallTextEl.innerHTML = t.smallText.replace(/\n/g, "<br>");

      // 再生ボタンの表示
      toggleBtn.textContent = isPlaying ? t.stopLabel : t.playLabel;
    }

    // ========= イベント設定 =========

    // スライダー → 即反映
    bpmSlider.addEventListener("input", () => {
      const bpm = clampBPM(parseInt(bpmSlider.value, 10));
      bpmInput.value = bpm;
      bpmDisplay.textContent = bpm;
      restartIfPlaying();
    });

    // 数値入力：途中は触らない
    bpmInput.addEventListener("input", () => {
      const raw = bpmInput.value;
      const num = parseInt(raw, 10);
      if (isNaN(num)) return;
      bpmDisplay.textContent = num;
      if (num >= 40 && num <= 240) {
        bpmSlider.value = num;
        restartIfPlaying();
      }
    });

    bpmInput.addEventListener("change", () => {
      let num = parseInt(bpmInput.value, 10);
      if (isNaN(num)) num = 120;
      const bpm = clampBPM(num);
      bpmInput.value = bpm;
      bpmSlider.value = bpm;
      bpmDisplay.textContent = bpm;
      restartIfPlaying();
    });

    // 拍子
    beatsPerBarInput.addEventListener("change", () => {
      let raw = parseInt(beatsPerBarInput.value, 10);
      if (isNaN(raw)) raw = 4;
      const beats = clampBeats(raw);
      if (beats !== raw) beatsPerBarInput.value = beats;
      beatsLabelCount.textContent = beats;
      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();
      restartIfPlaying();
    });

    // サブディビジョン
    subdivisionSelect.addEventListener("change", () => {
      updateSubLabel();
      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();
      restartIfPlaying();
    });

    // プリセット
    presetSelect.addEventListener("change", () => {
      updatePresetLabel();
      currentBeat = 0;
      currentStep = 0;
      updateIndicatorDots();
      restartIfPlaying();
    });

    // テンポ階段 ON/OFF
    ladderEnabledCheckbox.addEventListener("change", () => {
      if (!isPlaying) {
        if (ladderEnabledCheckbox.checked) {
          setLadderStatus(false);
        } else {
          stopLadderTimer();
        }
      } else {
        if (ladderEnabledCheckbox.checked) {
          startLadderIfNeeded();
        } else {
          stopLadderTimer();
        }
      }
    });

    toggleBtn.addEventListener("click", () => {
      if (!isPlaying) {
        startMetronome();
      } else {
        stopMetronome();
      }
    });

    // 言語切り替え
    langButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const lang = btn.getAttribute("data-lang");
        currentLang = (lang === "en") ? "en" : "ja";
        langButtons.forEach(b => b.classList.toggle("active", b === btn));
        applyTranslations();
      });
    });

    // 初期言語判定 & 初期表示
    (function initLang() {
      const userLang = (navigator.language || navigator.userLanguage || "en").toLowerCase();
      currentLang = userLang.startsWith("ja") ? "ja" : "en";
      langButtons.forEach(btn => {
        const lang = btn.getAttribute("data-lang");
        btn.classList.toggle("active", lang === currentLang);
      });
      applyTranslations();
      updateIndicatorDots();
      setLadderStatus(false);
    })();
  </script>
</body>
</html>
